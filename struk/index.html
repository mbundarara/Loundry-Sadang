<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loundry Sadang</title>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f5f5f5;}
.container{padding:10px;max-width:600px;margin:auto;}
input,select,button,textarea{width:100%;padding:8px;margin:5px 0;box-sizing:border-box;font-size:14px;}
button{background:#4CAF50;color:white;border:none;cursor:pointer;font-size:14px;}
button:hover{background:#45a049;}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
th,td{border:1px solid #ddd;padding:5px;text-align:center;}
th{background:#ddd;font-weight:bold;}
.status-terkirim{color:green;font-weight:bold;}
.status-belum{color:red;font-weight:bold;}
.progress-bar{width:100%;background:#ddd;margin:5px 0;}
.progress-fill{width:0%;height:15px;background:#4CAF50;text-align:center;color:white;font-size:12px;}
@media print {
  body{background:#fff;}
  .container{width:58mm;padding:2mm;margin:0;}
  table, th, td{border:1px solid #000;font-size:10px;}
  button,input,select,textarea,.progress-bar,#search{display:none;}
}
</style>
</head>
<body>
<div class="container" id="appDiv">
  <h2>Input Struk</h2>
  <input type="text" id="nama" placeholder="Nama">
  <input type="text" id="alamat" placeholder="Alamat">
  <input type="text" id="wa" placeholder="No WA (awal 0)">
  <input type="text" id="layanan" placeholder="Jenis Layanan">
  <select id="status">
    <option value="Diterima">Diterima</option>
    <option value="Proses">Proses</option>
    <option value="Selesai">Selesai</option>
  </select>
  <textarea id="keterangan" placeholder="Keterangan"></textarea>
  <input type="text" id="total" placeholder="Total (Rp)" oninput="formatRupiah(this)">
  <button onclick="saveStruk()">Simpan Struk</button>
  <div id="previewStruk"></div>
  <div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div>
  <hr>
  <h3>Cari Struk</h3>
  <input type="text" id="search" placeholder="Cari nama / no WA / no struk">
  <button onclick="searchStruk()">Cari</button>
  <div id="searchResult"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxXnlgEfyoylt0tZWzJNkAka_tEv9Lx5BSt9zkXhwhYW8xMr9qrPWWP24pzJEfsjMb5/exec";
let historyData = [];

// Format Rupiah
function formatRupiah(el){
  let num = el.value.replace(/\D/g,'');
  el.value = 'Rp ' + new Intl.NumberFormat('id-ID').format(num);
}

// Simpan offline
function saveOffline(data){
  let offline = JSON.parse(localStorage.getItem('offline'))||[];
  offline.push(data);
  localStorage.setItem('offline',JSON.stringify(offline));
}

// Sinkronisasi offline
function syncOffline(){
  let offline = JSON.parse(localStorage.getItem('offline'))||[];
  if(!navigator.onLine || offline.length===0) return;
  let total = offline.length;
  offline.forEach((d,i)=>{
    fetch(API_URL,{method:'POST',body:new URLSearchParams({action:'save',data:JSON.stringify(d))})
    .then(()=> {
      document.getElementById('progressFill').style.width=Math.round(((i+1)/total)*100)+'%';
      document.getElementById('progressFill').innerText=Math.round(((i+1)/total)*100)+'%';
      if(i===total-1){
        alert('Semua data offline berhasil diunggah');
        localStorage.removeItem('offline');
        loadHistory();
      }
    });
  });
}

// Simpan struk
function saveStruk(){
  let data = {
    nama: document.getElementById('nama').value,
    alamat: document.getElementById('alamat').value,
    wa: document.getElementById('wa').value,
    layanan: document.getElementById('layanan').value,
    status: document.getElementById('status').value,
    keterangan: document.getElementById('keterangan').value,
    total: Number(document.getElementById('total').value.replace(/\D/g,'')),
    user: "Admin"
  };
  if(!navigator.onLine){
    saveOffline(data); alert('Offline: Data tersimpan sementara'); displayPreview(data,'-'); return;
  }
  fetch(API_URL,{method:'POST',body:new URLSearchParams({action:'save',data:JSON.stringify(data)})})
  .then(r=>r.text()).then(noStruk=>{
    displayPreview(data,noStruk);
    loadHistory();
  });
}

// Tampilkan preview
function displayPreview(data,noStruk){
  const html = `<pre>
Loundry Sadang
Jl. Masjid Baiturohim Rt 05
----------------------------
No: ${noStruk}
Tanggal: ${new Date().toLocaleString('id-ID')}
Nama: ${data.nama}
Alamat: ${data.alamat}
WA: ${data.wa}
Layanan: ${data.layanan}
Status: ${data.status}
Keterangan: ${data.keterangan}
Total: Rp ${data.total.toLocaleString('id-ID')}
----------------------------
WA/Dana: 0851 7219 1936
a.n: Hilman Firmansyah
</pre>
<button onclick="shareWA('${noStruk}')">Share WA</button>
<button onclick="copyStruk('${noStruk}')">Copy</button>
<button onclick="printStruk('${noStruk}')">Print</button>`;
  document.getElementById('previewStruk').innerHTML = html;
}

// Copy ke clipboard
function copyStruk(noStruk){
  const s = document.querySelector('#previewStruk pre').innerText;
  navigator.clipboard.writeText(s).then(()=>alert('Disalin ke clipboard'));
}

// Print
function printStruk(noStruk){
  const s = document.querySelector('#previewStruk pre').innerText;
  const w = window.open('','Print','width=300,height=600');
  w.document.write('<pre>'+s+'</pre>'); w.print();
}

// Share WA
function shareWA(noStruk){
  const s = document.querySelector('#previewStruk pre').innerText;
  window.open('https://wa.me/085172191936?text='+encodeURIComponent(s),'_blank');
}

// Load history
function loadHistory(){
  fetch(API_URL,{method:'POST',body:new URLSearchParams({action:'getHistory'})})
  .then(r=>r.json()).then(data=>historyData=data);
}

// Cari struk
function searchStruk(){
  const q = document.getElementById('search').value.toLowerCase();
  const found = historyData.find(s=>s.nama.toLowerCase().includes(q)||s.wa.includes(q)||s.noStruk.includes(q));
  if(found) displayPreview(found,found.noStruk);
  else document.getElementById('searchResult').innerText='Struk tidak ditemukan';
}

window.addEventListener('online',syncOffline);
loadHistory();
</script>
</body>
</html>